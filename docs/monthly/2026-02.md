---
title: 2026年 2月
description: Ruby on Rails PR Digest - 2026年 2月にマージされたPRの要約
lastUpdated: 2026-02-04
---

# Ruby on Rails PR Digest - 2026年 2月

> このページは [rails/rails](https://github.com/rails/rails) リポジトリにマージされたPull Requestを自動的に収集し、AIで要約したものです。


## [#56725](https://github.com/rails/rails/pull/56725) Fix broken links to YJIT documentation [ci skip] {#pr-56725}

**マージ日**: 2026/2/3 | **作成者**: [@ykttdn](https://github.com/ykttdn)

1. 概要 (1–2文で)  
Rails Guides（パフォーマンスチューニングガイド）内で、YJITドキュメントへのリンクが Ruby 本体側の変更により壊れていたため、正しい YJIT ドキュメント URL に更新した PRです。コードの挙動や機能には影響せず、ドキュメントのリンク修正のみを行っています。

---

2. 変更内容の詳細  

- 対象ファイル: `guides/source/tuning_performance_for_deployment.md`
- 変更内容:  
  - YJIT に関する説明箇所で参照している外部リンク（YJIT ドキュメント）を、Ruby 本体リポジトリ側の最新のドキュメント構成に合わせて修正。
  - 差分としては、既存リンク 3 箇所前後を、新しい URL に置き換える形で `+3/-3` の変更が行われています。

実際の差分は PR 本文には出ていませんが、文脈から考えると、例えば次のようなイメージの修正です（あくまでイメージです）:

```markdown
- 詳細は Ruby の YJIT ドキュメントを参照してください:
- https://docs.ruby-lang.org/en/master/YJIT.html
+ 詳細は Ruby の YJIT ドキュメントを参照してください:
+ https://docs.ruby-lang.org/en/master/yjit/README_rdoc.html
```

Ruby 本体側でのドキュメントパス変更が、下記 PR で行われており、それに追随した形です。  
- https://github.com/ruby/ruby/pull/12305  
- https://github.com/ruby/ruby/pull/15154  

---

3. 影響範囲・注意点  

- 影響範囲:
  - Rails Guides（特に「本番環境向けパフォーマンスチューニング」ガイド）を読む際に、YJIT に関する参照リンクが正しく機能するようになります。
  - アプリケーションコードや Rails 本体の挙動には一切影響なし（ドキュメントのみの変更）。
  - テストや CHANGELOG 更新は、チェックリスト上は考慮されていますが、実質は「ドキュメント変更のため不要」という扱いです。

- 注意点:
  - もし自分の社内 Wiki やブログなどで旧 YJIT ドキュメントの URL を参照している場合、この PR がヒントになるので、同様にリンク切れがないか確認するとよいです。
  - 将来 Ruby 側で再度ドキュメント構成が変わった場合も、Rails Guides が追随する必要があるため、YJIT ドキュメントの場所は Ruby 本体の変更に依存することを意識しておくとメンテ上有用です。

---

4. 参考情報 (あれば)  

- Ruby 本体側の関連 PR:
  - YJIT ドキュメントリファクタ/移動などを行った PR:
    - https://github.com/ruby/ruby/pull/12305  
    - https://github.com/ruby/ruby/pull/15154  
- Rails ガイド（edge版, 英語）  
  - Tuning Performance for Deployment (本 PR の対象ガイド):  
    - https://edgeguides.rubyonrails.org/tuning_performance_for_deployment.html  
- YJIT についての概要（Ruby 公式）  
  - https://github.com/ruby/ruby/tree/master/yjit

---


## [#56705](https://github.com/rails/rails/pull/56705) Fix AM::Serialization#read_attribute_for_serialization doc {#pr-56705}

**マージ日**: 2026/2/3 | **作成者**: [@p8](https://github.com/p8)

1. 概要 (1-2文で)  
ActiveModel::Serialization の `read_attribute_for_serialization` を、`alias` ベースの定義から通常メソッドとして定義し直すことで、公式ドキュメントに正しく掲載されるようにするとともに、引数を「キー1つ」に限定する PR です。挙動は従来と変えず、インターフェイスの明示化とドキュメント改善を目的としています。

---

2. 変更内容の詳細  

これまで `read_attribute_for_serialization` は、おそらく以下のように `send` の alias として定義されていました（実際のコードは概念的にこういう形です）:

```ruby
# 変更前（イメージ）
alias :read_attribute_for_serialization :send
```

この場合の問題点:

- **RDoc/YARD などのドキュメント生成ツールは、alias に対してはデフォルトではドキュメントを生成しない**ことが多い  
- そのため `read_attribute_for_serialization` が「ActiveModel::Serialization が提供する公式なフックメソッド」としてドキュメントに現れない  
- `send` を alias しているだけなので、**メソッドシグネチャ的には「任意個の引数」を受け取れるように見えてしまう**（実態としてはシリアライズ用途では1つのキーを渡すことを想定している）

この PR では、`read_attribute_for_serialization` を alias ではなく「明示的にメソッド定義」するように変更しています。

変更後のイメージ:

```ruby
def read_attribute_for_serialization(key)
  send(key)
end
```

ポイント:

- **メソッドとして明示的に定義**したことで、  
  - ドキュメント生成時に `read_attribute_for_serialization` がきちんと拾われる  
  - 引数名（`key`）や引数が1つであることがドキュメントに反映される
- 実装としては `send(key)` を呼び出しているだけなので、**動作上は従来とほぼ同等**  
- ただし、インターフェイスとして「キーを1つだけ受け取るメソッド」であることが**シグネチャ上も明確**になった

PR 説明文にもある通り:

> This also encodes the method signature to only accept a single key as argument, where `send` accepts any arguments.

つまり、元々 alias だったときは `send` の都合上「どんな引数リストでも理論上は通る」状態だったが、今回の変更で「キー1つだけを受け取る」メソッドとして仕様を固定化した、という位置付けです。

---

3. 影響範囲・注意点  

- **通常の ActiveModel / ActiveRecord モデル利用者への影響はほぼなし**  
  - 多くのケースでは `read_attribute_for_serialization(:attribute_name)` のように1引数で呼ばれており、その動作は変わりません。
- 影響があり得るケース:
  - `read_attribute_for_serialization` を**自前で多引数で呼び出していたコード**がある場合  
    - 例: `read_attribute_for_serialization(:foo, :bar)` のような使い方をしていた場合、今後は `ArgumentError` になる可能性があります（正式な想定外の使い方なので、今回の変更でより明確に不正と分かるようになったとも言えます）。
  - `read_attribute_for_serialization` を**オーバーライドしているクラス**が、シグネチャを `*args` などにしていた場合  
    - 互換性の観点では、`def read_attribute_for_serialization(key)` のように「単一キーを取るメソッド」として扱うのが望ましいです。  
- ドキュメント面:
  - 今後生成される Rails API ドキュメント上で `ActiveModel::Serialization#read_attribute_for_serialization` が表示されるようになり、**カスタマイズフックとして発見しやすく**なります。
  - シグネチャが明確になったことで、ライブラリアップデート時に IDE などでの補完や型サポート（RBS, Sorbet, etc.）にも寄与する可能性があります。

---

4. 参考情報 (あれば)  

- PR 本体: https://github.com/rails/rails/pull/56705  
- 関連する概念:
  - `ActiveModel::Serialization` モジュール: モデルオブジェクトをハッシュ化・JSON 化するための仕組み
  - `read_attribute_for_serialization`: シリアライズ時に各属性値を取得するためのフックメソッド。  
    モデル側でこのメソッドをオーバーライドすることで、「シリアライズ時だけ別の値を返す」といったカスタマイズが可能です。

---


## [#56724](https://github.com/rails/rails/pull/56724) Remove useless connection verification when pinning connection {#pr-56724}

**マージ日**: 2026/2/3 | **作成者**: [@byroot](https://github.com/byroot)

1. 概要 (1-2文で)  
このPRでは、コネクションを「ピン留め」するときに毎回行っていた `verify!` 呼び出しを削除し、既に実装されている「最近使われたコネクションは再検証しない」ロジックに一元化することで、無駄なコネクション検証をなくしています。結果として、不要なクエリ（例: `SELECT 1`）の発行が減り、Active Record のコネクション管理がわずかに効率化されます。

---

2. 変更内容の詳細  

### 全体像
- 対象: ActiveRecord のコネクションプールおよび抽象アダプタ
- 主な変更:
  - コネクションを「pin（固定）」する際に行っていた明示的な `verify!` 呼び出しを削除
  - その代わり、アダプタ側の「最近使用されたコネクションは再検証しない」ロジックに任せるよう整理

#### 変更点1: connection_pool 側の明示的な `verify!` 呼び出しの削除
`activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb` から、コネクションを pin するときに呼んでいた `connection.verify!` が削られています。

イメージとしては、以下のようなコードパスが:

```ruby
def pin_connection
  connection = checkout
  connection.verify!  # ← これが削除された
  @pinned_connection = connection
end
```

のような形から、「チェックアウトしただけで即 `verify!` は呼ばない」挙動に変わった、という内容です（実際のメソッド名や詳細は簡略化していますが、意味合いとしてはこの通りです）。

元々 Active Record には以下のようなロジックが既にあります:
- コネクション取得時に「前回の使用時刻」等を見て、一定時間内に使われていれば `verify!` しない
- 逆に、長時間使われていない場合・接続断が疑われる場合などは `verify!` を行う

PR本文の "We now have some decent logic about not revalidating a connection that has been used recently" はまさにこの部分を指しています。  
したがって、pin 時の明示的な `verify!` はこのポリシーと二重になっており、「ほぼ常に不要なダブルチェック」になっていたため削除されています。

#### 変更点2: abstract_adapter 側のサポートコード追加
`activerecord/lib/active_record/connection_adapters/abstract_adapter.rb` には 6 行の追加があります。差分の狙いは、おそらく以下のような点です:

- 「最近使用されたコネクションは検証しない」ためのヘルパメソッドやタイムスタンプ管理の整理
- `verify!` 実装の一部を共通化、または条件付きでの実行に関するロジック強化

（具体的なメソッド名は差分全文がないため推測になりますが、PRメッセージから見て、`verify!` の呼び出し条件や「最近の使用」を判定するロジックに関わるコードである可能性が高いです）

この追加により、以下がより明確になります:
- 「いつ `verify!` すべきか」という判断をアダプタ側（および関連ヘルパ）に集約
- connection_pool 側は「検証ポリシーを知らない」薄い層になり、責務分離が改善

---

3. 影響範囲・注意点  

### 影響範囲
- 対象となるのは、**マルチ DB / シャーディング / connection switching** などで「コネクションをピン留めする」仕組みを使っているアプリケーションやライブラリです。
- また、独自アダプタや、connection_pool / adapter をモンキーパッチしている場合は影響受ける可能性があります。

### 実務的な影響
1. **無駄なヘルスチェックの減少**
   - これまで、ピン時に毎回 `SELECT 1` 的な検証クエリが走っていたケースが、不要な場合には実行されなくなります。
   - 大量のコネクション切り替えが発生する高トラフィック環境では、わずかながらもレイテンシ・DB 負荷が軽減される可能性があります。

2. **接続の信頼性**
   - 「長時間使われていないコネクションをピンした途端、壊れていた」というケースは、従来どおり抽象アダプタの `verify!` ロジックで検出される設計です。
   - PRの意図としては「不要な二重チェックを削っただけ」であり、「接続が切れているのに気づけなくなる」ような性質の変更ではないことが示唆されています。

3. **カスタムコードとの互換性**
   - もしアプリや gem 側が「ピン時に `verify!` が必ず呼ばれること」を前提にしたワークアラウンドを積んでいた場合、その前提は崩れます。
   - 典型的には、`verify!` をオーバーライドして何か副作用（ログ、メトリクス、独自リカバリ等）を期待していた場合などです。
   - こうしたコードは、「verify! の呼び出しタイミングは ActiveRecord の内部実装詳細であり、将来的に変わりうる」ものとして見直す必要があります。

### 注意点
- DB 接続まわりで「特定のタイミングでだけ接続チェックをしたい」といった特殊要件がある場合は、この変更後の `verify!` 呼び出しパターン（どこで、いつ実行されるか）を実際にログ等で確認しておくと安心です。
- 接続プール関連のバグやタイムアウト問題をデバッグする際には、「ピン時には自動で `verify!` されない」という前提でコードリーディングを行う必要があります。

---

4. 参考情報 (あれば)  

- 関連コード:
  - `activerecord/lib/active_record/connection_adapters/abstract_adapter.rb`
  - `activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb`
- 背景となる Active Record の挙動:
  - コネクションプールは各コネクションの「最終使用時刻」などを管理し、一定時間以上アイドルだった場合のみ `verify!` を呼ぶといったポリシーを持っています。
  - `verify!` 自体は各アダプタ（PostgreSQL, MySQL, SQLite 等）が実装し、通常は軽量なクエリ (`SELECT 1` 等) による疎通確認を行います。

このPRは、そうした既存ロジックを前提に、「ピン留め時のダブルチェックをやめてシンプルにする」リファクタリング／最適化、と理解するとよいです。

---


## [#56716](https://github.com/rails/rails/pull/56716) [ci skip] Correct typo in ActiveRecord changelog {#pr-56716}

**マージ日**: 2026/2/3 | **作成者**: [@coderhs](https://github.com/coderhs)

1. 概要 (1-2文で)  
このPRは、Active Record の CHANGELOG に記載されていたデータベース接続に関する文言のタイポ（誤記）を修正するものです。コードや挙動の変更は一切なく、ドキュメントのみの修正です。

2. 変更内容の詳細  
- 対象ファイル: `activerecord/CHANGELOG.md`  
- 変更内容は 1 行のテキスト修正のみで、データベース接続（connections）に関する説明文中のスペルミスや用語の誤りを正しい表記に直しています。  
- [ci skip] がタイトルに含まれている通り、ドキュメント変更のみのため CI を走らせない PR です。  

実際のコードや API のシグネチャ、設定オプションなどは一切変更されていません。  
CHANGELOG 上の例示コードや、接続管理に関する説明の「単語」レベルの修正に留まると考えてよいです。

3. 影響範囲・注意点  
- ランタイム挙動: 影響なし  
  - Active Record の接続管理やクエリ実行、トランザクション動作などには一切変更がありません。  
- マイグレーション・設定: 変更不要  
  - `database.yml` などの設定ファイルの見直しや、アプリケーション側のコード修正も不要です。  
- CHANGELOG の読み取り:  
  - 今後、該当バージョンの変更点を確認する際に、より正確な記述に基づいて挙動を理解できるようになります。  
  - 既に CHANGELOG を参照していた場合は、「あれ？文脈的におかしいな」と感じていた箇所が自然な表現に直っている程度の差分です。

4. 参考情報 (あれば)  
- このPRはドキュメント修正専用のため、Rails をバージョンアップしても今回の変更が原因で不具合が出ることはありません。  
- 実際の接続管理ロジックや API の仕様を確認したい場合は、CHANGELOG よりも以下を優先するとよいです:  
  - `activerecord` の公式ガイド: 「Active Record Basics」「Active Record Connection Handling」関連セクション  
  - 対象バージョンの API ドキュメント (`ActiveRecord::Base.connection`, `ActiveRecord::ConnectionAdapters` など)

---


## [#56683](https://github.com/rails/rails/pull/56683) Pass sql query to query log tags {#pr-56683}

**マージ日**: 2026/2/2 | **作成者**: [@fatkodima](https://github.com/fatkodima)

1. 概要 (1–2文で)  
Active Record の「クエリログタグ (query_log_tags)」に、実行される SQL 文字列がコンテキストとして渡されるようになりました。これにより、SQL 内容に応じた柔軟なタグ付けやデバッグ情報の付与が簡単に行えます。

---

2. 変更内容の詳細  

### 何が変わったか

従来 `config.active_record.query_log_tags` で設定した Proc には、主に「バックトレース 1 行分」などの情報が `context` として渡されていましたが、この PR により `context[:sql]` として「実際に実行される SQL 文字列」も渡されるようになりました。

これにより、SQL に基づいたタグ生成が可能になります。

#### 新しい使い方の例

PR 説明にある例:

```ruby
config.active_record.query_log_tags = [
  sql_length: ->(context) { context[:sql].length }
]
```

この設定により、各 SQL 実行時のログに「クエリ文字列の長さ」をタグとして付与できます。  
（実際のログのフォーマットは既存の query log tags の仕組みに従います。）

これと同様に、例えば以下のような応用が可能です:

```ruby
config.active_record.query_log_tags = [
  # レプリカ向けクエリかどうかを SQL から推定してタグ付け
  replica_candidate: ->(context) do
    sql = context[:sql]
    # 例: 特定テーブルへの読み取りはレプリカを想定、など
    sql.match?(/FROM\s+large_read_only_table/i)
  end,

  # 危険そうなクエリの検出用タグ
  uses_select_star: ->(context) do
    context[:sql].match?(/\bselect\s+\*/i)
  end,
]
```

### 実装面でのポイント

（ファイル差分の要約）

- `activerecord/lib/active_record/query_logs.rb`
  - クエリログタグを構築する際のコンテキストに `:sql` キーが追加された。
  - 既存のタグ生成フローは保ちつつ、SQL 文字列を渡すだけの後方互換的な拡張。

- `activerecord/test/cases/query_logs_test.rb`
  - `context[:sql]` が利用可能であることを検証するテストが追加。

- `activerecord/CHANGELOG.md`
  - Active Record の変更点として、本機能追加が記載された。

---

3. 影響範囲・注意点  

- **既存コードへの影響**
  - `context` に新たに `:sql` が追加されるだけで、既存の `query_log_tags` 設定はそのまま動作します。
  - 既存タグ定義が `context` のキーを前提にしていても、`sql` の追加は破壊的変更にはなりません。

- **セキュリティ / プライバシー**
  - `context[:sql]` をそのままログタグに出力すると、クエリ文字列（およびバインドされるパラメータ内容）がログに露出しやすくなります。
  - 個人情報や機密情報がプレーンテキストで SQL に含まれるケースでは、マスキングやハッシュ化などの処理を行うべきです。
    ```ruby
    config.active_record.query_log_tags = [
      sql_fingerprint: ->(context) do
        # SQL 全体は出さず、ハッシュにして特徴だけログに残す
        Digest::SHA256.hexdigest(context[:sql])
      end
    ]
    ```

- **パフォーマンス**
  - 非常に長い SQL や大量のクエリに対して、タグ計算が重くなるロジックを書くとオーバーヘッドになる可能性があります。
  - タグで SQL をそのまま出力するより、長さやハッシュ、正規表現による判定など、必要な情報に絞ることが推奨されます。

- **レプリカ切り替えデバッグの用途**
  - PR 動機にもある通り、「なぜこのクエリがレプリカに飛ばないのか」を調べるために、特定条件の SQL にだけ追加のバックトレース情報やフラグをログに埋め込む、といった使い方が容易になります。
  - 今までも `ActiveSupport::Notifications.subscribe("sql.active_record")` で実現可能でしたが、`query_log_tags` 設定だけで完結するようになり、アプリケーション設定として管理しやすくなります。

---

4. 参考情報 (あれば)  

- この PR: https://github.com/rails/rails/pull/56683  
- 関連 API:
  - `config.active_record.query_log_tags`
  - `ActiveSupport::Notifications` (`"sql.active_record"` イベント)  
- Active Record のクエリログタグに関するドキュメント（最新の Rails ガイド / API リファレンスを参照）

---


## [#56695](https://github.com/rails/rails/pull/56695) Use a single temporary connection pool when checking test schema {#pr-56695}

**マージ日**: 2026/2/2 | **作成者**: [@ilianah](https://github.com/ilianah)

1. 概要 (1-2文で)  
テスト用スキーマのチェック時に、1つの DB 設定につき「2つ」作られていた一時的なコネクションプールを「1つ」に統合し、同じプールを使い回すようにした PR です。これにより、テスト時のスキーマ・マイグレーション確認処理のオーバーヘッドが削減されます。

---

2. 変更内容の詳細  

### 背景 / 問題点

`ActiveRecord::Migration.load_schema_if_pending!` は、以下の2つの処理を行う際に一時的なコネクションプールを使っています:

1. スキーマが最新かどうかのチェック
2. 保留中マイグレーション（pending migrations）のチェック

従来は「それぞれで別々に一時プールを作成」していたため、  
**1 DB 設定あたり 2 回プール作成 → 2 回クリーンアップ**  
という無駄なコストが生じていました。

### この PR の変更点

この PR では、テスト用スキーマを確認する処理で:

- 1つの一時的なコネクションプールを作成
- そのプールを
  - スキーマのチェック
  - pending マイグレーションのチェック
  の両方で「再利用」するように変更しています。

主な変更点のポイント:

- `ActiveRecord::Migration.load_schema_if_pending!` 内のロジックを整理し、
  - これまで別々に呼んでいた「スキーマ更新の要否確認」と「pending マイグレーションの確認」を、
  - 同一プールを共有するフローにした。
- `ActiveRecord::Tasks::DatabaseTasks` 側のヘルパーメソッド（スキーマチェック関連）も、それに合わせて一時プールの扱いを調整。
- `activerecord/CHANGELOG.md` に、この挙動改善に関するエントリを追加。

※ PR タイトルと説明、および差分の規模（3ファイル / +50 -17）から判断すると、挙動を変えるというよりは「内部実装の効率化」が主で、API 仕様の変更は行っていません。

---

3. 影響範囲・注意点  

**影響する場面:**

- `ActiveRecord::Migration.load_schema_if_pending!` を通じて、
  - テストスイート起動時にスキーマ／マイグレーション状態をチェックする処理
  - 複数 DB（multiple databases）を利用しているプロジェクトのテスト環境
- 特に、DB 接続確立コストが高い環境（リモート DB、制限された CI リソースなど）では、わずかながら起動時間やリソース消費の改善が見込めます。

**注意点:**

- 1つの一時プールで2種類のチェックを行うため、もしアプリ側が「pending マイグレーションチェック時の接続状態」に過度に依存しているような特殊なコードを書いていた場合、動きに差異が出る可能性はありますが、通常の Rails アプリでは想定されません。
- 公開 API（メソッドシグネチャなど）には変更がない想定なので、既存コードの修正は基本的に不要です。
- コネクションプールのライフサイクル管理（作成・クリーンアップ）がまとめられているため、万一そこにバグがあるとテスト時の接続リークにつながる可能性はありますが、PR ではテストも追加・更新されている旨がチェック項目で示唆されています。

---

4. 参考情報 (あれば)  

- 対象メソッド:  
  - `ActiveRecord::Migration.load_schema_if_pending!`
  - `ActiveRecord::Tasks::DatabaseTasks` 内のスキーマチェック用ユーティリティ
- 変更ログ:  
  - `activerecord/CHANGELOG.md` に、テストスキーマチェック時の一時コネクションプール最適化に関する項目が追加されています。  
- 関連するコンテキスト:  
  - Rails のテスト起動時には、`load_schema_if_pending!` が走り、  
    - `db/schema.rb` または `db/structure.sql` が最新か
    - まだ適用されていないマイグレーションがないか  
    を確認します。  
  - この PR はその裏側の「接続管理」の最適化であり、テストスキーマ周りの一般的なワークフロー（`bin/rails db:test:prepare` など）には表面的な変更はありません。

---


## [#56715](https://github.com/rails/rails/pull/56715) [ci skip] Fix formatting of backtrace description in configuring.md {#pr-56715}

**マージ日**: 2026/2/2 | **作成者**: [@coderhs](https://github.com/coderhs)

1. 概要 (1-2文で)  
configuring.md ガイド内の backtrace 説明文に含まれていた不要な英単語 "the" を削除し、文章のフォーマット／文法を整えたドキュメント修正です。コードや挙動には一切影響せず、ドキュメントのみの微修正です。

2. 変更内容の詳細(あればサンプルコードも含めて)  
- 対象ファイル: `guides/source/configuring.md`  
- 変更点は1行のみで、backtrace に関する説明文中の「extra `the`」(余分な "the") を削除しています。  
- 例 (イメージ):  
  ```diff
- This option controls the the format of the backtrace output...
+ This option controls the format of the backtrace output...
  ```
  のように、英語として不自然な重複を取り除き、読みやすい表現に修正しています。  
- PR タイトルに `[ci skip]` が付いていることからも分かる通り、テストやビルドは不要な単純なドキュメント修正として扱われています。

3. 影響範囲・注意点  
- Rails 本体のコード、設定オプション、API 仕様などには一切変更はありません。  
- 既存アプリケーション、設定ファイル (`config/environments/*.rb` など)、実行時の backtrace 表示やログ出力の挙動にも影響はありません。  
- 影響は Rails ガイドの読み手 (特に backtrace / エラー出力の設定方法を確認する開発者) に限定され、文章がわずかに読みやすくなっただけです。

4. 参考情報 (あれば)  
- PR: https://github.com/rails/rails/pull/56715  
- 対象ガイド: Rails Guides「Configuring Rails Applications」(configuring.md)  
  - backtrace の設定方法や関連オプションを確認する際に参照するドキュメントの一部の文言修正です。

---


## [#56712](https://github.com/rails/rails/pull/56712) [ci skip] Fix typo in test/guide stategy -> strategy {#pr-56712}

**マージ日**: 2026/2/1 | **作成者**: [@coderhs](https://github.com/coderhs)

1. 概要 (1-2文で)  
Railsのテストコードとガイド文書内にあった「stategy / statetgy」というタイポが、正しい「strategy」に修正されたPRです。機能追加や挙動変更は一切なく、ドキュメントおよびテストの表記を整えるメンテナンス目的の変更です。

---

2. 変更内容の詳細  

### 対象ファイル
- `activerecord/test/cases/migration_test.rb`
- `guides/source/active_record_migrations.md`

両方とも、Active Record のマイグレーションに関連する箇所で、用語「strategy」の表記ゆれ・タイポがありました。

#### 具体的な修正例（イメージ）

```diff
- def test_migration_stategy
+ def test_migration_strategy
```

あるいはコメントや説明文中の:

```diff
- This statetgy is used when...
+ This strategy is used when...
```

といった形で、「strategy」という単語の綴りだけが修正されています。

PRタイトルに `[ci skip]` が付いているのは、テキスト修正のみでありテスト実行を省略する目的です（CIを走らせるほどの変更ではないため）。

---

3. 影響範囲・注意点  

- **ランタイムの挙動への影響なし**  
  実行コード（ライブラリ部分）は変更されておらず、テストコードとガイド文書のみの修正です。そのため、Railsアプリケーションの挙動やAPI仕様には影響しません。

- **テスト名・メッセージに依存している場合の注意**  
  もし `migration_test.rb` 内のテスト名やエラーメッセージ文字列に対して、外部ツール（例: テスト結果パーサ、メトリクス集計ツールなど）が「文字列完全一致」で依存している場合、名称変更によって影響を受ける可能性があります。ただし、通常のRailsアプリ開発ではほぼ問題にならない範囲です。

- **ドキュメントの可読性向上のみ**  
  ガイドを読んでいる際に、「stategy / statetgy」という誤記がなくなり、用語の一貫性が高まりました。学習・調査の際に混乱が減る程度の改善です。

---

4. 参考情報 (あれば)  

- PR: https://github.com/rails/rails/pull/56712  
- ガイド該当箇所（Active Record Migrations ガイド）:  
  https://guides.rubyonrails.org/active_record_migrations.html  
  ※ 本PRマージ後、英語版ガイド上の「strategy」に関連する説明文が正しいスペルで表示されます。

---


## [#56426](https://github.com/rails/rails/pull/56426) Make `rescue_from_handled.action_controller` store the full backtrace {#pr-56426}

**マージ日**: 2026/2/1 | **作成者**: [@zzak](https://github.com/zzak)

1. 概要 (1-2文で)  
`config.action_controller.rescue_from_event_backtrace` を `:array` に設定した場合、`rescue_from_handled.action_controller` 通知ペイロードにも「フルバックトレース（配列）」が載るようにした変更です。併せて、バックトレースから `Rails.root` を削った形で保持する処理や、関連設定・ガイド・テストの整備が行われています。

---

2. 変更内容の詳細

### 2-1. 新しい設定オプションの挙動

既存フラグ:  
- `config.action_controller.rescue_from_event_backtrace`

この設定を `:array` にすると、

- `action_controller.rescue`（既存）
- `action_controller.rescue_from_handled`（Rails 8.1 からの新イベント）

の両方の通知ペイロードで「フルバックトレース」が **配列形式** で格納されます。

以前は、`rescue_from_handled` 側ではこの設定が十分に反映されておらず、フルバックトレースがペイロードに入っていませんでしたが、この PR で揃えられています。

イメージ（通知ハンドラから参照される payload）:

```ruby
ActiveSupport::Notifications.subscribe("rescue_from_handled.action_controller") do |name, started, finished, unique_id, payload|
  # ここに full_backtrace が array として入るようになる
  backtrace = payload[:backtrace] # => ["app/controllers/users_controller.rb:10:in `index'", ...]
end
```

※ 実際のキー名は実装側に依存しますが、PR の文脈から「配列形式のバックトレース」が通知されることがポイントです。

### 2-2. `Rails.root` プレフィックスの削除

テストが追加されたと書かれている通り、バックトレースの各行から `Rails.root` を `delete_prefix` する処理が導入されています。

例:  
`/my/app/path/app/controllers/users_controller.rb:10:in 'index'`  
→ `app/controllers/users_controller.rb:10:in 'index'`

これにより、

- ログやイベントペイロードのパスがより短く読みやすくなる
- パスに環境依存要素（フルパス）が含まれにくくなる（オブザーバビリティツールやマルチ環境での集計に有利）

といった効果があります。

### 2-3. サブスクライバ・ログサブスクライバ周りの変更

以下のあたりが更新されています:

- `action_controller/structured_event_subscriber.rb`
- `action_controller/log_subscriber.rb`
- `action_controller/railtie.rb`

主な意図は:

- `rescue_from_handled.action_controller` イベントのペイロードに、`rescue_from_event_backtrace` 設定を反映させる
- バックトレースの整形（`Rails.root` の削除）を共通化しつつ、通知に適切な形で乗せる

### 2-4. 新フレームワークデフォルトと設定ガイド

次バージョン (8.2) のためのテンプレートが更新されています:

- `config/initializers/new_framework_defaults_8_2.rb.tt` に `rescue_from_event_backtrace` 関連の初期値やコメントを追加
- `guides/source/configuring.md` に該当オプションの説明を追加

これにより、新規アプリで `rails app:update` を行った時に、この設定項目とデフォルトの意味がガイド/initializer コメントを通じて明示されます。

---

3. 影響範囲・注意点

### 3-1. オブザーバビリティ（o11y）やログ集約への影響

- `rescue_from_handled.action_controller` イベントをすでに購読している場合、ペイロードの `backtrace` 関連の中身が変わる/増える可能性があります。
- 特に `:array` を指定している場合、**これまでより詳細なバックトレース情報が入る** ため:
  - ログ・APM・トレーシングツールのフィールドマッピングが変わる可能性
  - 取り込むデータ量が増える（バックトレース全行分）点に注意

作者も PR 説明で「既に o11y 側でこのイベントを取り込み始めた人がいるかもしれないため、互換性に配慮したい」と述べているため、**ペイロード仕様に依存しているコードがないか要確認**です。

### 3-2. ファイルパスの変化

`delete_prefix(Rails.root)` により、

- 以前フルパスを期待していた処理（例: 特定ディレクトリ配下のファイル検出を絶対パスで行う等）
- パスを正規表現でマッチさせていた処理

がある場合、**パス形式が変化しても問題ないか確認が必要**です。  
特に、SaaS APM などで「source map」や「code link」を張る仕組みを自前で組んでいる場合はパス解決ロジックを併せて見直してください。

### 3-3. 将来的な非推奨化の可能性

PR 説明文中で、作者はこのフラグを将来的に:

- deprecate（非推奨）し
- remove（削除）

することも視野に入れているとコメントしています。  
現時点では削除はされていませんが、以下のような流れが予想されます:

1. 8.1/8.2 でこの挙動を提供（今回の PR）
2. CHANGELOG とガイドで周知
3. 将来バージョンでフラグを非推奨化し、デフォルト挙動の一本化を検討

そのため、**長期的には「フラグに依存しない」かたちの運用**（例: 「常にフルバックトレースを想定する」）を前提に観測・ロギング側を設計すると、将来の変更の影響を減らせます。

---

4. 参考情報 (あれば)

- この PR:  
  https://github.com/rails/rails/pull/56426
- 関連 issue（Fixes: #56060 と言及あり）:  
  https://github.com/rails/rails/issues/56060
- 関連するイベント名:
  - `rescue_from_handled.action_controller`（Rails 8.1 で追加された新イベント）
  - `rescue.action_controller` / `rescue_with_handler.action_controller` 系の既存イベントとの仕様差に注意するとよいです。

運用上は、`config.action_controller.rescue_from_event_backtrace = :array` を有効にした状態で、実際に発火する通知ペイロードをローカルやステージング環境で `ActiveSupport::Notifications` からダンプして、中身を確認しておくことを推奨します。

---


## [#56454](https://github.com/rails/rails/pull/56454) Add `unique_by` option to `insert_all!` {#pr-56454}

**マージ日**: 2026/2/1 | **作成者**: [@chaadow](https://github.com/chaadow)

1. 概要 (1-2文で)  
`ActiveRecord::Relation#insert_all!` に `unique_by:` オプションが追加され、既に対応済みだった `insert_all` と同等のインターフェイスになりました。これにより、一括INSERT時に使用するユニークインデックスを `insert_all!` 側でも明示的に指定できるようになります。

---

2. 変更内容の詳細  

### 何ができるようになったか

これまで:

```ruby
# OK: insert_all は unique_by オプションを受け取れた
User.insert_all(records, unique_by: :index_users_on_email)

# NG: insert_all! には unique_by を渡せなかった
User.insert_all!(records, unique_by: :index_users_on_email) # ⇒ 引数エラーになる
```

このPR後:

```ruby
# insert_all! でも unique_by を指定可能に
User.insert_all!(
  [
    { email: "a@example.com", name: "Alice" },
    { email: "b@example.com", name: "Bob" }
  ],
  unique_by: :index_users_on_email
)
```

`unique_by:` で、複数存在し得るユニークインデックスのどれを「衝突判定」に使うかを明示できます。  
PostgreSQL や SQLite などの `INSERT ... ON CONFLICT` を持つDBで、複数ユニーク制約があるテーブルに対して挙動を制御する際に重要です。

### 実装的なポイント

- `ActiveRecord::Relation#insert_all!` のメソッド定義が更新され、キーワード引数で `unique_by:` を受け取るようになっています。
- 受け取った `unique_by:` は、内部で利用している `ActiveRecord::InsertAll` にそのまま渡されるだけで、実装としては既存機能の公開インターフェイスを揃えた形です。
- `activerecord/test/cases/insert_all_test.rb` に、`insert_all!` で `unique_by:` を指定した場合のテストが追加されています。
  - 例: 特定のユニークインデックス名や、列の組み合わせを指定しても動作することを確認。
- `activerecord/CHANGELOG.md` に、新しいオプションサポートとして追記されています。

### `unique_by` の指定方法（おさらい）

`unique_by` が取れる値は、既存の `insert_all` と共通です (DBごとにサポート内容は多少異なる):

- インデックス名（Symbol / String）  
  `unique_by: :index_users_on_email`
- カラム名の配列  
  `unique_by: %i[email account_id]`
- 一部アダプタでは unique constraint 名なども使用可能

これらは内部で `ON CONFLICT (columns...)` もしくは `ON CONSTRAINT constraint_name` に変換されます。

---

3. 影響範囲・注意点  

- **API の一貫性向上**  
  既に存在していた `insert_all` と `insert_all!` のオプション差分が解消されます。アプリ側で「普段は `insert_all` だが、場合によっては `insert_all!` に切り替える」といったケースでも、共通のオプションセットを使いやすくなります。

- **既存コードへの影響**  
  - シグネチャ変更は、「新しく `unique_by:` を受け付けるようになった」だけで、既存の呼び出しはそのまま動作します。
  - `unique_by:` というキーワード引数をすでにアプリ側で独自ラッパー等に渡していても、Rails本体がそれを受け取ってくれるようになるだけなので、互換性上の問題はほぼありません。

- **DBごとの挙動への依存**  
  - `unique_by:` の解釈は DB アダプタに依存します。指定したインデックス名／カラムが実際に存在しない場合は DBエラーになります。
  - もともと `insert_all` で使っていたロジックを `insert_all!` でもそのまま使えるようになっただけなので、DBまわりの制約は従来通りと考えてよいです。

- **使い分けの考え方**  
  - `insert_all` … 重複時に「スキップ」あるいは「更新」など、エラーを出さずに処理を進めたい場合。
  - `insert_all!` … 衝突・不正データなどがあれば**例外を投げてほしい**場合。  
  どちらでも `unique_by:` を揃って使えるようになったので、方針に応じてメソッドだけ切り替えればOKです。

---

4. 参考情報 (あれば)  

- 元PR: [#45317](https://github.com/rails/rails/pull/45317) — 今回はその再投稿版  
- 関連ドキュメント（英語）:  
  - Rails Guides – Active Record クエリインターフェイス / Bulk inserts (Rails edge / 7.x 以降)  
- 実際の構文の詳細・サポート状況は、`ActiveRecord::InsertAll` のクラスコメントおよび各アダプタ(例: `ActiveRecord::ConnectionAdapters::PostgreSQLAdapter`)の実装を参照すると理解しやすいです。

---


## [#56681](https://github.com/rails/rails/pull/56681) Make `ActionText::Attachable#read_attribute_for_serialization` public {#pr-56681}

**マージ日**: 2026/2/1 | **作成者**: [@sallyhall](https://github.com/sallyhall)

1. 概要 (1-2文で)  
`ActionText::Attachable` がオーバーライドしている `read_attribute_for_serialization` メソッドを `public` に変更し、元の `ActiveModel::Serialization` 側の可視性と揃えた PR です。これにより、`active_model_serializers` で `ActionText::Attachable` を含むモデルをシリアライズした際に発生していたエラーが解消されます。

---

2. 変更内容の詳細  

### 背景

- `ActiveModel::Serialization#read_attribute_for_serialization` は、以前は `protected/private` 相当の扱いでしたが、[過去の PR](https://github.com/rails/rails/pull/53042) により **public メソッド** になりました。
- 一方で `ActionText::Attachable` モジュールは、その `read_attribute_for_serialization` を **private メソッドとしてオーバーライド** していました（`private` な領域に定義していた）。
- その結果、「本体は public なのに、サブクラス/インクルード先で private 扱いにされている」という不整合が生じ、`active_model_serializers` がシリアライズ時にこのメソッドを呼び出そうとすると、可視性の不一致によりエラーが発生していました。  
  - 実際の不具合報告: https://github.com/rails-api/active_model_serializers/issues/2457

### この PR の変更点

主な変更は 3 点です。

1. **`ActionText::Attachable#read_attribute_for_serialization` の可視性を public に変更**
   - これまで `private` 節の中で定義されていた、あるいは実質的に private として扱われていたメソッドを `public` メソッドにしました。
   - 意図としては、「オーバーライド元である `ActiveModel::Serialization#read_attribute_for_serialization` の可視性 (public) と揃える」ための変更です。

   ざっくりイメージすると、以下のような変更が入っています（実際のコードは若干異なりますが、概念として）:

   ```ruby
   module ActionText
     module Attachable
       # 以前
       # private
       #
       # def read_attribute_for_serialization(attr)
       #   # ActionText の attachable 用の独自処理
       # end

       # 変更後（public として定義し直し）
       def read_attribute_for_serialization(attr_name)
         # ActiveModel::Serialization と整合する形で、
         # ActionText の属性取得ロジックを実装
         super
       end
     end
   end
   ```

   実際には `super` 呼び出しや ActionText 独自ロジックが含まれますが、「メソッドシグネチャは維持しつつ、可視性のみ public に揃えた」というのがポイントです。

2. **テスト追加 (`actiontext/test/unit/attachable_test.rb`)**
   - `read_attribute_for_serialization` が public として利用できること、およびシリアライズ時に問題なく動作することを確認するユニットテストが追加されています。
   - これにより、今後 `ActiveModel::Serialization` 側で仕様変更があっても、可視性の不整合が再発するのを防ぐ意図があります。

3. **CHANGELOG 更新 (`actiontext/CHANGELOG.md`)**
   - Action Text の CHANGELOG に「`ActionText::Attachable#read_attribute_for_serialization` を public にした」という変更が記載されました。
   - これは挙動に影響しうるため、利用者がバージョンアップ時に把握できるようにするためです。

---

3. 影響範囲・注意点  

### 主な影響範囲

- **影響を受けるのは、`ActionText::Attachable` を利用していて、かつ `ActiveModel::Serialization` / `active_model_serializers` と組み合わせているケース** です。
  - 例: `ActionText` を使ったモデル (`has_rich_text` を持つなど) を `ActiveModelSerializers` で JSON 化しているアプリケーション。

- これまで発生していた以下のような問題が解消されます:
  - シリアライザ内部で `object.read_attribute_for_serialization(:some_attribute)` のような呼び出しが行われる際、`ActionText::Attachable` を mixin したオブジェクトだけ `NoMethodError` や `private method 'read_attribute_for_serialization' called` などが出ていた問題。

### 互換性・副作用の可能性

- `read_attribute_for_serialization` が **public になった**ことで、
  - すでにこのメソッドを呼んでいたコードは、今後も問題なく動作し続けます（以前は private 呼び出しや `send` を使っていた場合でも、今後は堂々と public として呼べる）。
  - 新たにこのメソッドを外部から直接呼び出すことも技術的には可能になりますが、Rails の慣習上「シリアライズのためのフック」としての位置づけは変わりません。

- もしアプリ側で `ActionText::Attachable#read_attribute_for_serialization` を **独自にオーバーライドしていて、可視性を private にしていた** 場合は、  
  - Rails 本体側の変更と可視性がずれるため、`public` に揃えることが推奨されます。

---

4. 参考情報 (あれば)  

- 本 PR: https://github.com/rails/rails/pull/56681  
- `ActiveModel::Serialization#read_attribute_for_serialization` を public にした変更:  
  https://github.com/rails/rails/pull/53042  
- 発端となった不具合報告 (`active_model_serializers` 側):  
  https://github.com/rails-api/active_model_serializers/issues/2457

---


## [#56711](https://github.com/rails/rails/pull/56711) Fix code block for product show view the correct change in guide {#pr-56711}

**マージ日**: 2026/1/31 | **作成者**: [@arceus3115](https://github.com/arceus3115)

1. 概要 (1-2文で)  
このPRは、Railsガイド「Getting Started」の `getting_started.md` 内にある *product の show ビュー* のコード例を、実際の推奨実装と一致するように1行だけ修正したドキュメント変更です。アプリケーションコード自体には一切手を入れておらず、ガイドのコードブロックの齟齬を解消するためのものです。

---

2. 変更内容の詳細(あればサンプルコードも含めて)  

- 対象ファイル: `guides/source/getting_started.md`
- 変更行数: +1 / -1（1行差し替え）

PRタイトルの「Fix code block for product show view the correct change in guide」から分かる通り、**「Getting Started with Rails」ガイドの中で紹介されている `products#show` ビューのコード例**が、最新のガイドの文脈やその直前で説明している内容と食い違っていたため、そのコードブロックを正しい内容に合わせています。

典型的には、以下のような差分が想定されます（実際の差分イメージ）:

**修正前 (例)**

```erb
<!-- 古い、または説明と合っていない show.html.erb の例 -->
<p>
  <strong>Title:</strong>
  <%= @product.title %>
</p>

<p>
  <strong>Description:</strong>
  <%= @product.description %>
</p>
```

**修正後 (例)**

```erb
<!-- ガイド本文で説明している、最新の show.html.erb の例 -->
<p>
  <strong>Title:</strong>
  <%= @product.title %>
</p>

<p>
  <strong>Description:</strong>
  <%= @product.description %>
</p>

<p>
  <strong>Price:</strong>
  <%= number_to_currency(@product.price) %>
</p>
```

実際の差分は1行だけですが、ニュアンスとしては:

- ガイド本文でさきほど説明したコードと、  
- コードブロックに掲載しているサンプル

が一致するように、属性名・メソッド・ヘルパーの呼び出しなどを1行修正した、というタイプの変更です。

内容的には以下のような種類の補正である可能性が高いです:

- `@product` ではなく `product` を使っていた / その逆
- `link_to` の引数やパスヘルパーが、直前の章で変更したルーティングと噛み合っていない
- 表示するカラム名（`title` → `name` など）が現在のチュートリアルのモデル定義と一致していない
- ガイドで「こう書き換えましょう」と説明した後の最終版が、コードブロックに反映されていない

PR文の "Update the code block in getting_started.md to reflect changes in the show view." からも、「show ビューの正しい変更内容をガイドのコードブロックに反映させた」という意図であることが分かります。

---

3. 影響範囲・注意点  

- **影響範囲**
  - Rails本体の挙動やAPIには一切影響しません。
  - 「Getting Started」ガイドを見ながらアプリを作成しているユーザーが、  
    - ガイドの文章どおりの変更を行ったときに、  
    - コード例との不一致で混乱する  
    という問題を解消します。
  - これにより、**チュートリアルに従っても動かない / 表示が違う**といった初学者向けのハードルが下がります。

- **注意点**
  - ドキュメントのみの変更のため、アプリケーションコードやテストの更新は不要です。
  - Getting Started を教材として利用している場合（社内研修・勉強会資料など）、  
    - スクリーンショットや転記しているコードが旧バージョンに依存している場合は、それらをガイドの最新版に合わせて更新した方が混乱が少ないです。

---

4. 参考情報 (あれば)  

- 該当PR: https://github.com/rails/rails/pull/56711  
- Rails公式ガイド（Edge Guides / Getting Started）:  
  - https://edgeguides.rubyonrails.org/getting_started.html  
    （英語版。該当箇所は `products#show` のビューを作成・修正するセクション）

---

